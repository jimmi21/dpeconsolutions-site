const menuBtn=document.getElementById('menuBtn');const nav=document.getElementById('nav');if(menuBtn)menuBtn.addEventListener('click',()=>nav.classList.toggle('show'));document.getElementById('year').textContent=new Date().getFullYear();document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener('click',e=>{const id=a.getAttribute('href').slice(1);const el=document.getElementById(id);if(el){e.preventDefault();el.scrollIntoView({behavior:'smooth',block:'start'});nav?.classList.remove('show');}})});const themeSelect=document.getElementById('themeSelect');const htmlEl=document.documentElement;const logo=document.getElementById('logo');function applyTheme(t){htmlEl.setAttribute('data-theme',t);if(t==='light'){logo.style.filter='none'}else if(t==='greige'){logo.style.filter='none'}else{logo.style.filter='none'}try{localStorage.setItem('dpas_theme',t);}catch{}}let initial='dark';try{const saved=localStorage.getItem('dpas_theme');if(saved) initial=saved;}catch{}themeSelect.value=initial;applyTheme(initial);themeSelect.addEventListener('change',()=>applyTheme(themeSelect.value));
/* Calculator logic reused (short) */
const TAX_TABLES={'2025':{EMP:[{upTo:10000,rate:.09},{upTo:20000,rate:.22},{upTo:30000,rate:.28},{upTo:40000,rate:.36},{upTo:Infinity,rate:.44}],RENT:[{upTo:12000,rate:.15},{upTo:35000,rate:.35},{upTo:Infinity,rate:.45}]},'2024':{EMP:[{upTo:10000,rate:.09},{upTo:20000,rate:.22},{upTo:30000,rate:.28},{upTo:40000,rate:.36},{upTo:Infinity,rate:.44}],RENT:[{upTo:12000,rate:.15},{upTo:35000,rate:.35},{upTo:Infinity,rate:.45}]}};function childrenCredit(c){if(c<=0)return 777;if(c===1)return 900;if(c===2)return 1120;if(c===3)return 1340;if(c===4)return 1580;if(c===5)return 1780;return 1780+(c-5)*220}function phasedCredit(credit,salary,children){if(children>=5)return credit;const excess=Math.max(0,(salary||0)-12000);const steps=Math.floor(excess/1000);const reduction=steps*20;return Math.max(0,credit-reduction)}function calcProgressiveDetailed(a,b){let r=Math.max(0,a||0),p=0,rows=[],t=0;for(const x of b){const s=x.upTo===Infinity?Infinity:(x.upTo-p);const part=Math.min(r,s);if(part>0){const tax=part*x.rate;rows.push({range:x.upTo===Infinity?`${fmt(p+1)}+`:`${fmt(p+1)}–${fmt(x.upTo)}`,amount:part,rate:x.rate,tax});t+=tax;r-=part}if(x.upTo!==Infinity)p=x.upTo;if(r<=0)break}return {rows,total:Math.round(t)}}function fmt(n){return new Intl.NumberFormat('el-GR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n||0)}function toCSV(rows){const head=['Κλιμάκιο','Ποσό','Συντελεστής','Φόρος'];const body=rows.map(r=>[r.range,r.amount,(r.rate*100).toFixed(0)+'%',Math.round(r.tax)]);return [head,...body].map(line=>line.join(';')).join('\n')}const elYear=document.getElementById('taxYear'),elAdv=document.getElementById('advanceRate'),elDuty=document.getElementById('businessDuty'),elSalary=document.getElementById('incSalary'),elBus=document.getElementById('incBusiness'),elRent=document.getElementById('incRental'),elChildren=document.getElementById('children'),elPrepaid=document.getElementById('prepaid'),elCredits=document.getElementById('credits');const outSalary=document.getElementById('taxSalary'),outBusiness=document.getElementById('taxBusiness'),outAdvance=document.getElementById('taxAdvance'),outRent=document.getElementById('taxRental'),outDuty=document.getElementById('taxDuty'),outPrepaid=document.getElementById('taxPrepaid'),outCredits=document.getElementById('taxCredits'),outTotal=document.getElementById('taxTotal');const tblSalary=document.querySelector('#tblSalary tbody'),tblBusiness=document.querySelector('#tblBusiness tbody'),tblRent=document.querySelector('#tblRental tbody');function renderRows(tb,rows){tb.innerHTML='';rows.forEach(r=>{const tr=document.createElement('tr');['range','amount','rate','tax'].forEach((k,i)=>{const td=document.createElement('td');td.textContent=i==1?fmt(r[k]):(i==2?(r[k]*100).toFixed(0)+'%':(i==3?fmt(Math.round(r[k])):r[k]));tr.appendChild(td)});tb.appendChild(tr)});if(!rows.length){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=4;td.style.textAlign='center';td.textContent='—';tr.appendChild(td);tb.appendChild(tr)}}function calculate(){const y=elYear.value,t=TAX_TABLES[y],ar=parseFloat(elAdv.value)||0,du=Math.max(0,parseFloat(elDuty.value)||0),s=Math.max(0,parseFloat(elSalary.value)||0),b=Math.max(0,parseFloat(elBus.value)||0),r=Math.max(0,parseFloat(elRent.value)||0),c=Math.max(0,Math.floor(parseFloat(elChildren.value)||0)),pp=Math.max(0,parseFloat(elPrepaid.value)||0),cr=Math.max(0,parseFloat(elCredits.value)||0);const dS=calcProgressiveDetailed(s,t.EMP),dB=calcProgressiveDetailed(b,t.EMP),dR=calcProgressiveDetailed(r,t.RENT),base=childrenCredit(c),ph=phasedCredit(base,s,c),applied=Math.min(dS.total,Math.round(ph)),sAfter=Math.max(0,dS.total-applied),adv=Math.round(dB.total*ar),gross=sAfter+dB.total+dR.total+adv+du,final=gross-pp-cr;outSalary.textContent=fmt(sAfter);outBusiness.textContent=fmt(dB.total);outAdvance.textContent=fmt(adv);outRent.textContent=fmt(dR.total);outDuty.textContent=fmt(du);outPrepaid.textContent='-'+fmt(pp);outCredits.textContent='-'+fmt(cr);outTotal.textContent=(final>=0)?fmt(final):(fmt(Math.abs(final))+' επιστρεπτέο');renderRows(tblSalary,dS.rows);renderRows(tblBusiness,dB.rows);renderRows(tblRent,dR.rows);try{localStorage.setItem('dpas_calc_dark_logo',JSON.stringify({y,ar,du,s,b,r,c,pp,cr}))}catch{}}document.getElementById('calcBtn')?.addEventListener('click',calculate);document.getElementById('clearBtn')?.addEventListener('click',()=>{[elSalary,elBus,elRent,elDuty,elChildren,elPrepaid,elCredits].forEach(el=>el.value='');elAdv.value='0';elYear.value='2025';calculate()});document.getElementById('printBtn')?.addEventListener('click',()=>window.print());document.getElementById('csvBtn')?.addEventListener('click',()=>{const y=elYear.value;let csv=`Έτος;${y}\n`;csv+=`\νΜισθωτά/Συντάξεις\n`+toCSV(readRows(tblSalary));csv+=`\n\nΕπιχειρ. δραστηριότητα\n`+toCSV(readRows(tblBusiness));csv+=`\n\nΑκίνητα\n`+toCSV(readRows(tblRent));const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`dpas_tax_${y}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)});function readRows(tb){const rows=[];tb.querySelectorAll('tr').forEach(tr=>{const c=tr.querySelectorAll('td');if(c.length===4&&c[0].textContent!=='—'){rows.push({range:c[0].textContent,amount:Number(c[1].textContent.replace(/[^0-9]/g,'')),rate:Number(c[2].textContent.replace('%',''))/100,tax:Number(c[3].textContent.replace(/[^0-9]/g,''))})}});return rows}calculate();