/* Minimal v5 rebuild: nav, theme (greige default), booking (.ics + email + quick slots), calculator (persist/print/csv) */
const menuBtn=document.getElementById('menuBtn');const nav=document.getElementById('nav');menuBtn&&menuBtn.addEventListener('click',()=>nav.classList.toggle('show'));document.getElementById('year')&&(document.getElementById('year').textContent=(new Date).getFullYear());document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener('click',e=>{const t=a.getAttribute('href').slice(1),n=document.getElementById(t);n&&(e.preventDefault(),n.scrollIntoView({behavior:"smooth",block:"start"}),nav?.classList.remove("show"))})});
const themeSelect=document.getElementById('themeSelect'),htmlEl=document.documentElement;function applyTheme(e){e&&(htmlEl.setAttribute('data-theme',e),localStorage.setItem('dpas_theme',e))}if(themeSelect){let e=localStorage.getItem('dpas_theme')||'greige';themeSelect.value=e,applyTheme(e),themeSelect.addEventListener('change',()=>applyTheme(themeSelect.value))}
document.querySelector('[data-jump="meeting"]')?.addEventListener('click',()=>{document.getElementById('meeting')?.scrollIntoView({behavior:'smooth',block:'start'})});
(function(){const btn=document.getElementById('meetBook');if(!btn)return;const f=document.getElementById('meetForm'),dt=document.getElementById('meetAt'),name=document.getElementById('meetName'),contact=document.getElementById('meetContact'),note=document.getElementById('meetNote');function fmtDate(d){return d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'}
(function(){const cont=document.getElementById('quickSlots');if(!cont||!dt)return;function next(){const now=new Date();function at(day,h){const d=new Date();d.setDate(now.getDate()+day);d.setHours(h,0,0,0);return d}return[at(0,11),at(0,17),at(1,11),at(1,17)].filter(d=>d.getTime()>Date.now()).slice(0,4)}function label(d){return d.toLocaleDateString('el-GR',{weekday:'short',day:'2-digit',month:'2-digit'})+' • '+d.toLocaleTimeString('el-GR',{hour:'2-digit',minute:'2-digit'})}const list=next();if(list.length){cont.innerHTML='<div class="slot-wrap"></div>';const w=cont.querySelector('.slot-wrap');list.forEach(s=>{const b=document.createElement('button');b.type='button';b.className='btn small ghost slot-btn';b.textContent=label(s);b.addEventListener('click',()=>{dt.value=new Date(s.getTime()-(new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);dt.dispatchEvent(new Event('change'))});w.appendChild(b)})}})();
const replyto=document.getElementById('meet_hidden_replyto');function sync(){const v=(contact.value||'').trim();replyto.value=v.includes('@')?v:''}contact.addEventListener('input',sync);sync();
btn.addEventListener('click',e=>{e.preventDefault();const dtErr=document.getElementById('meetAtError'),contErr=document.getElementById('meetContactError');let valid=true;dt.classList.remove('invalid');contact.classList.remove('invalid');dtErr&&dtErr.classList.remove('active');contErr&&contErr.classList.remove('active');if(!dt.value){dt.classList.add('invalid');dtErr&&dtErr.classList.add('active');valid=false}if(!contact.value){contact.classList.add('invalid');contErr&&contErr.classList.add('active');valid=false}if(!valid)return;const start=new Date(dt.value),end=new Date(start.getTime()+15*60000),ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//DPAS//Meeting//EL
BEGIN:VEVENT
UID:${Date.now()}@dpas
DTSTAMP:${fmtDate(new Date())}
DTSTART:${fmtDate(start)}
DTEND:${fmtDate(end)}
SUMMARY:Σύντομη γνωριμία — D.P. Accounting Solutions
DESCRIPTION:${(note.value||'').replace(/\n/g,' ')}
LOCATION:Τηλεφωνικά: 2431076222 — Email: dpeconsolutions@gmail.com
END:VEVENT
END:VCALENDAR`;const blob=new Blob([ics],{type:"text/calendar"}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download="dpas_meeting.ics";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);document.getElementById('meet_hidden_dt').value=start.toLocaleString('el-GR');document.getElementById('meet_hidden_name').value=name.value||'-';document.getElementById('meet_hidden_contact').value=contact.value;document.getElementById('meet_hidden_note').value=note.value||'-';const tempTarget='_meetSubmit',prevTarget=f.getAttribute('target');f.setAttribute('target',tempTarget);const iframe=document.createElement('iframe');iframe.name=tempTarget;iframe.style.display='none';document.body.appendChild(iframe);btn.textContent='Έγινε κράτηση — δες το .ics';setTimeout(()=>{btn.textContent='Κράτηση 15’ & λήψη .ics'},2500);f.submit();setTimeout(()=>{document.body.removeChild(iframe);f.setAttribute('target',prevTarget||'_blank')},3500)})})();
const TAX_TABLES={"2025":{EMP:[{upTo:1e4,rate:.09},{upTo:2e4,rate:.22},{upTo:3e4,rate:.28},{upTo:4e4,rate:.36},{upTo:1/0,rate:.44}],RENT:[{upTo:12e3,rate:.15},{upTo:35e3,rate:.35},{upTo:1/0,rate:.45}]},"2024":{EMP:[{upTo:1e4,rate:.09},{upTo:2e4,rate:.22},{upTo:3e4,rate:.28},{upTo:4e4,rate:.36},{upTo:1/0,rate:.44}],RENT:[{upTo:12e3,rate:.15},{upTo:35e3,rate:.35},{upTo:1/0,rate:.45}]}};function childrenCredit(k){return k<=0?0:1===k?900:2===k?1120:3===k?1340:4===k?1580:5===k?1780:1780+220*(k-5)}function phasedCredit(base,salary,kids){if(kids>=5)return base;const over=Math.max(0,(salary||0)-12e3),steps=Math.floor(over/1e3);return Math.max(0,base-20*steps)}function calcProg(amount,table){let n=Math.max(0,amount||0),prev=0,rows=[],tax=0;for(const b of table){const cap=b.upTo===1/0?1/0:b.upTo-prev,s=Math.min(n,cap);if(s>0){const t=Math.round(s*b.rate);rows.push({range:b.upTo===1/0?`${(prev+1).toLocaleString('el-GR')} € και άνω`:`${(prev+1).toLocaleString('el-GR')}–${b.upTo.toLocaleString('el-GR')} €`,amount:s,rate:b.rate,tax:t});tax+=t;n-=s}if(b.upTo!==1/0)prev=b.upTo;if(n<=0)break}return{rows,total:tax}}function fmt(x){return new Intl.NumberFormat('el-GR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(x||0)}function tableCSV(tb){const head=["Κλίμακες Φορολογίας","Ποσό","Συντελεστής","Φόρος"];const rows=[...tb.querySelectorAll("tr")].map(tr=>[...tr.querySelectorAll("td")].map(td=>td.textContent));return[...([head]),...rows].map(r=>r.join(";")).join("\n")}const el={taxYear:document.getElementById('taxYear'),advanceRate:document.getElementById('advanceRate'),businessDuty:document.getElementById('businessDuty'),incSalary:document.getElementById('incSalary'),incBusiness:document.getElementById('incBusiness'),incRental:document.getElementById('incRental'),children:document.getElementById('children'),prepaid:document.getElementById('prepaid'),credits:document.getElementById('credits')},out={salary:document.getElementById('taxSalary'),business:document.getElementById('taxBusiness'),advance:document.getElementById('taxAdvance'),rental:document.getElementById('taxRental'),duty:document.getElementById('taxDuty'),prepaid:document.getElementById('taxPrepaid'),credits:document.getElementById('taxCredits'),total:document.getElementById('taxTotal')},tb={salary:document.querySelector('#tblSalary tbody'),business:document.querySelector('#tblBusiness tbody'),rent:document.querySelector('#tblRental tbody')};function renderRows(tbody,rows){if(!tbody)return;tbody.innerHTML='';if(!rows.length){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=4;td.style.textAlign='center';td.textContent='—';tr.appendChild(td);tbody.appendChild(tr);return}rows.forEach(r=>{const tr=document.createElement('tr'),c1=document.createElement('td'),c2=document.createElement('td'),c3=document.createElement('td'),c4=document.createElement('td');c1.textContent=r.range;c2.textContent=fmt(r.amount);c3.textContent=(100*r.rate).toFixed(0)+'%';c4.textContent=fmt(Math.round(r.tax));tr.append(c1,c2,c3,c4);tbody.appendChild(tr)})}function calculate(){const yr=el.taxYear.value,t=TAX_TABLES[yr],adv=parseFloat(el.advanceRate.value)||0,duty=Math.max(0,parseFloat(el.businessDuty.value)||0),s=Math.max(0,parseFloat(el.incSalary.value)||0),b=Math.max(0,parseFloat(el.incBusiness.value)||0),r=Math.max(0,parseFloat(el.incRental.value)||0),kids=Math.max(0,Math.floor(parseFloat(el.children.value)||0)),pre=Math.max(0,parseFloat(el.prepaid.value)||0),cred=Math.max(0,parseFloat(el.credits.value)||0),sal=calcProg(s,t.EMP),bus=calcProg(b,t.EMP),ren=calcProg(r,t.RENT),base=childrenCredit(kids),ph=phasedCredit(base,s,kids),used=Math.min(sal.total,Math.round(ph)),salAfter=Math.max(0,sal.total-used),advTax=Math.round(bus.total*adv),total=salAfter+bus.total+ren.total+advTax+duty-pre-cred;out.salary.textContent=fmt(salAfter);out.business.textContent=fmt(bus.total);out.advance.textContent=fmt(advTax);out.rental.textContent=fmt(ren.total);out.duty.textContent=fmt(duty);out.prepaid.textContent='-'+fmt(pre);out.credits.textContent='-'+fmt(cred);out.total.textContent=total>=0?fmt(total):fmt(Math.abs(total))+' επιστρεπτέο';renderRows(tb.salary,sal.rows);renderRows(tb.business,bus.rows);renderRows(tb.rent,ren.rows)}document.getElementById('calcBtn')?.addEventListener('click',calculate);document.getElementById('clearBtn')?.addEventListener('click',()=>{['incSalary','incBusiness','incRental','businessDuty','children','prepaid','credits'].forEach(id=>el[id].value='');el.advanceRate.value='0';el.taxYear.value='2025';calculate()});document.getElementById('csvBtn')?.addEventListener('click',()=>{const yr=el.taxYear.value;let csv=`Έτος;${yr}\n`;csv+=`\nΜισθωτά/Συντάξεις\n`+tableCSV(tb.salary);csv+=`\n\nΕπιχειρ. δραστηριότητα\n`+tableCSV(tb.business);csv+=`\n\nΑκίνητα\n`+tableCSV(tb.rent);const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`dpas_tax_${yr}.csv`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)});
/* Scroll-to-top button */
const scrollTopBtn=document.getElementById('scrollTop');if(scrollTopBtn){window.addEventListener('scroll',()=>{scrollTopBtn.classList.toggle('visible',window.scrollY>300)});scrollTopBtn.addEventListener('click',()=>{window.scrollTo({top:0,behavior:'smooth'})})}
/* Print handler - opens calculator in new window for printing */
document.getElementById('printBtn')?.addEventListener('click',()=>{calculate();function tbodyHTML(sel){return document.querySelector(sel)?.innerHTML||''}const win=window.open('','_blank');if(!win)return;const css=`@page{size:auto;margin:12mm}body{font-family:'Inter',Arial;margin:24px;color:#111}h1,h2,h3{font-family:'Source Serif 4',Georgia,serif}.brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}.brand img{height:96px;border-radius:12px}.muted{color:#555}.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}.summary{border:1px solid #ddd;border-radius:10px;padding:12px}table{width:100%;border-collapse:collapse;margin-top:6px}th,td{border:1px solid #ddd;padding:6px 8px;text-align:right}th:first-child,td:first-child{text-align:left}th{font-weight:700}.total{font-weight:700;font-size:1.1rem}`;const yr=el.taxYear.value,now=new Date().toLocaleString('el-GR'),summaryHTML=document.querySelector('.summary')?.innerHTML||'',logoSrc=document.getElementById('logo')?.src||'';const doc=`<!doctype html><html><head><meta charset="utf-8"><title>Εκτύπωση — Υπολογιστής Φόρου</title><style>${css}</style></head><body><div class="brand"><img src="${logoSrc}" alt="Logo"><div><h2>D.P. Accounting Solutions</h2><div class="muted">Υπολογιστής φόρου — Έτος ${yr} • ${now}</div></div></div><div class="grid"><div class="summary">${summaryHTML}</div><div><h3>Μισθωτά/Συντάξεις</h3><table><thead><tr><th>Κλίμακες</th><th>Ποσό</th><th>%</th><th>Φόρος</th></tr></thead><tbody>${tbodyHTML('#tblSalary tbody')}</tbody></table><h3>Επιχειρ. δραστηριότητα</h3><table><thead><tr><th>Κλίμακες</th><th>Ποσό</th><th>%</th><th>Φόρος</th></tr></thead><tbody>${tbodyHTML('#tblBusiness tbody')}</tbody></table><h3>Ακίνητα</h3><table><thead><tr><th>Κλίμακες</th><th>Ποσό</th><th>%</th><th>Φόρος</th></tr></thead><tbody>${tbodyHTML('#tblRental tbody')}</tbody></table></div></div><script>window.onload=()=>{window.print()}<\/script></body></html>`;win.document.open();win.document.write(doc);win.document.close()});
