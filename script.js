/* nav + theme + calculator + print + csv */
const menuBtn=document.getElementById('menuBtn');const nav=document.getElementById('nav');if(menuBtn)menuBtn.addEventListener('click',()=>nav.classList.toggle('show'));document.getElementById('year')&&(document.getElementById('year').textContent=(new Date).getFullYear());document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener('click',e=>{const t=a.getAttribute('href').slice(1),n=document.getElementById(t);n&&(e.preventDefault(),n.scrollIntoView({behavior:"smooth",block:"start"}),nav?.classList.remove("show"))})});const header=document.getElementById('siteHeader');if(header){let e=0;window.addEventListener('scroll',()=>{const t=window.scrollY||document.documentElement.scrollTop;t>80&&e<=80?header.classList.add('shrink'):t<=80&&e>80&&header.classList.remove('shrink'),e=t})}const themeSelect=document.getElementById('themeSelect'),htmlEl=document.documentElement;function applyTheme(e){e&&(htmlEl.setAttribute('data-theme',e),localStorage.setItem('dpas_theme',e))}if(themeSelect){let e='greige';const t=localStorage.getItem('dpas_theme');t&&(e=t),themeSelect.value=e,applyTheme(e),themeSelect.addEventListener('change',()=>applyTheme(themeSelect.value))}
const TAX_TABLES={"2025":{EMP:[{upTo:1e4,rate:.09},{upTo:2e4,rate:.22},{upTo:3e4,rate:.28},{upTo:4e4,rate:.36},{upTo:1/0,rate:.44}],RENT:[{upTo:12e3,rate:.15},{upTo:35e3,rate:.35},{upTo:1/0,rate:.45}]},"2024":{EMP:[{upTo:1e4,rate:.09},{upTo:2e4,rate:.22},{upTo:3e4,rate:.28},{upTo:4e4,rate:.36},{upTo:1/0,rate:.44}],RENT:[{upTo:12e3,rate:.15},{upTo:35e3,rate:.35},{upTo:1/0,rate:.45}]}};function childrenCredit(e){return e<=0?777:1===e?900:2===e?1120:3===e?1340:4===e?1580:5===e?1780:1780+220*(e-5)}function phasedCredit(e,t,n){if(n>=5)return e;const a=Math.max(0,(t||0)-12e3),r=Math.floor(a/1e3);return Math.max(0,e-20*r)}function calcProgressiveDetailed(e,t){let n=Math.max(0,e||0),a=0,r=[],o=0;for(const e of t){const t=1/0===e.upTo?"και άνω":e.upTo.toLocaleString("el-GR"),s=(a+1).toLocaleString("el-GR"),l=1/0===e.upTo?1/0:e.upTo-a,i=Math.min(n,l);if(i>0){const t=Math.round(i*e.rate);r.push({range:1/0===e.upTo?`${s} € και άνω`:`${s}–${t} €`,amount:i,rate:e.rate,tax:t}),o+=t,n-=i}if(e.upTo!==1/0&&(a=e.upTo),n<=0)break}return{rows:r,total:o}}function fmt(e){return new Intl.NumberFormat("el-GR",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(e||0)}function tableToCSV(e){const t=["Κλίμακες Φορολογίας","Ποσό","Συντελεστής","Φόρος"],n=[...e.querySelectorAll("tr")].map(e=>[...e.querySelectorAll("td")].map(e=>e.textContent));return[t,...n].map(e=>e.join(";")).join("\n")}const elYear=document.getElementById("taxYear"),elAdv=document.getElementById("advanceRate"),elDuty=document.getElementById("businessDuty"),elSalary=document.getElementById("incSalary"),elBus=document.getElementById("incBusiness"),elRent=document.getElementById("incRental"),elChildren=document.getElementById("children"),elPrepaid=document.getElementById("prepaid"),elCredits=document.getElementById("credits"),outSalary=document.getElementById("taxSalary"),outBusiness=document.getElementById("taxBusiness"),outAdvance=document.getElementById("taxAdvance"),outRent=document.getElementById("taxRental"),outDuty=document.getElementById("taxDuty"),outPrepaid=document.getElementById("taxPrepaid"),outCredits=document.getElementById("taxCredits"),outTotal=document.getElementById("taxTotal"),tblSalary=document.querySelector("#tblSalary tbody"),tblBusiness=document.querySelector("#tblBusiness tbody"),tblRent=document.querySelector("#tblRental tbody");function renderRows(e,t){if(!e)return;e.innerHTML="",t.forEach(t=>{const n=document.createElement("tr"),a=document.createElement("td");a.textContent=t.range;const r=document.createElement("td");r.textContent=fmt(t.amount);const o=document.createElement("td");o.textContent=(100*t.rate).toFixed(0)+"%";const s=document.createElement("td");s.textContent=fmt(Math.round(t.tax)),n.append(a,r,o,s),e.appendChild(n)}),t.length||(()=>{const t=document.createElement("tr"),n=document.createElement("td");n.colSpan=4,n.style.textAlign="center",n.textContent="—",t.appendChild(n),e.appendChild(t)})()}function calculate(){if(!elYear)return;const e=elYear.value,t=TAX_TABLES[e],n=parseFloat(elAdv.value)||0,a=Math.max(0,parseFloat(elDuty.value)||0),r=Math.max(0,parseFloat(elSalary.value)||0),o=Math.max(0,parseFloat(elBus.value)||0),s=Math.max(0,parseFloat(elRent.value)||0),l=Math.max(0,Math.floor(parseFloat(elChildren.value)||0)),i=Math.max(0,parseFloat(elPrepaid.value)||0),c=Math.max(0,parseFloat(elCredits.value)||0),d=calcProgressiveDetailed(r,t.EMP),u=calcProgressiveDetailed(o,t.EMP),m=calcProgressiveDetailed(s,t.RENT),y=childrenCredit(l),p=phasedCredit(y,r,l),h=Math.min(d.total,Math.round(p)),g=Math.max(0,d.total-h),v=Math.round(u.total*n),f=g+u.total+m.total+v+a,b=f-i-c;outSalary.textContent=fmt(g),outBusiness.textContent=fmt(u.total),outAdvance.textContent=fmt(v),outRent.textContent=fmt(m.total),outDuty.textContent=fmt(a),outPrepaid.textContent="-"+fmt(i),outCredits.textContent="-"+fmt(c),outTotal.textContent=b>=0?fmt(b):fmt(Math.abs(b))+" επιστρεπτέο",renderRows(tblSalary,d.rows),renderRows(tblBusiness,u.rows),renderRows(tblRent,m.rows)}document.getElementById("calcBtn")?.addEventListener("click",calculate),document.getElementById("clearBtn")?.addEventListener("click",()=>{[elSalary,elBus,elRent,elDuty,elChildren,elPrepaid,elCredits].forEach(e=>e.value=""),elAdv.value="0",elYear.value="2025",calculate()}),document.getElementById("csvBtn")?.addEventListener("click",()=>{const e=elYear.value;let t=`Έτος;${e}\n`;t+=`\nΜισθωτά/Συντάξεις\n`+tableToCSV(document.querySelector("#tblSalary tbody")),t+=`\n\nΕπιχειρ. δραστηριότητα\n`+tableToCSV(document.querySelector("#tblBusiness tbody")),t+=`\n\nΑκίνητα\n`+tableToCSV(document.querySelector("#tblRental tbody"));const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=`dpas_tax_${e}.csv`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(a)}),document.getElementById("printBtn")?.addEventListener("click",()=>{function e(e){return document.querySelector(e).innerHTML}calculate();const t=window.open("","_blank"),n=`
    @page{size:auto;margin:12mm}
    body{font-family:'Inter',Arial; margin:24px; color:#111;}
    h1,h2,h3{font-family:'Source Serif 4', Georgia, 'Times New Roman', serif}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .brand img{height:96px;border-radius:12px}
    .muted{color:#555}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .summary{border:1px solid #ddd;border-radius:10px;padding:12px}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{border:1px solid #ddd;padding:6px 8px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    th{font-weight:700}
    .total{font-weight:700;font-size:1.1rem}
  `,a=document.getElementById("taxYear").value,r=(new Date).toLocaleString("el-GR"),o=document.querySelector(".summary").innerHTML,s=`<!doctype html><html><head><meta charset="utf-8"><title>Εκτύπωση — Υπολογιστής Φόρου</title><style>${n}</style></head>
  <body>
    <div class="brand"><img src="${document.getElementById("logo").src}" alt="Logo"><div><h2>D.P. Accounting Solutions</h2><div class="muted">Υπολογιστής φόρου — Έτος ${a} • ${r}</div></div></div>
    <div class="grid">
      <div class="summary">${o}</div>
      <div>
        <h3>Μισθωτά/Συντάξεις</h3>
        <table><thead><tr><th>Κλίμακες Φορολογίας</th><th>Ποσό</th><th>Συντελεστής</th><th>Φόρος</th></tr></thead><tbody>${e("#tblSalary tbody")}</tbody></table>
        <h3>Επιχειρ. δραστηριότητα</h3>
        <table><thead><tr><th>Κλίμακες Φορολογίας</th><th>Ποσό</th><th>Συντελεστής</th><th>Φόρος</th></tr></thead><tbody>${e("#tblBusiness tbody")}</tbody></table>
        <h3>Ακίνητα</h3>
        <table><thead><tr><th>Κλίμακες Φορολογίας</th><th>Ποσό</th><th>Συντελεστής</th><th>Φόρος</th></tr></thead><tbody>${e("#tblRental tbody")}</tbody></table>
      </div>
    </div>
    <script>window.onload=()=>{{window.print();}}</script>
  </body></html>`;t.document.open(),t.document.write(s),t.document.close()});
